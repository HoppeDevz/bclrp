local a=module('_core','libs/Tunnel')local b=module('_core','libs/Proxy')API=b.getInterface('API')cAPI=a.getInterface('cAPI')src={}a.bindInterface("gcphone",src)vRPclient=a.getInterface("vRP","gcphone")local c=module("_core","libs/Tools")local d=c.newIDGenerator()local e=""function src.checkItemPhone()local _source=source;local f=API.getUserFromSource(_source)if f then local g=f:getCharacter()if g then local h=parseInt(g.id)if g:getItemAmount("phone")>0 then return true else TriggerClientEvent("Notify",_source,"negado","Você precisa de um celular!")return false end end end end;math.randomseed(os.time())function getPhoneRandomNumber()local i=math.random(1000,9999)local j=math.random(0,9999)local num=string.format("%04d-%04d",i,j)return num end;function getNumberPhone(k)local l=MySQL.Sync.fetchAll("SELECT * FROM characters WHERE charid = @charid",{['@charid']=parseInt(k)})if l[1]~=nil then return l[1].phone end;return nil end;function getIdentifierByPhoneNumber(m)local l=MySQL.Sync.fetchAll("SELECT characters.charid FROM characters WHERE characters.phone = @phone_number",{['@phone_number']=m})if l[1]~=nil then return l[1].charid end;return nil end;function getPlayerID(source)local _source=source;local f=API.getUserFromSource(_source)if f then local g=f:getCharacter()if g then local h=parseInt(g.id)return h end end end;function getIdentifiant(n)for o,p in ipairs(n)do return p end end;function getOrGeneratePhoneNumber(q,r,s)local q=q;local r=r;local t=getNumberPhone(r)if t=='0'or t==nil then repeat t=getPhoneRandomNumber()local n=getIdentifierByPhoneNumber(t)until n==nil;MySQL.Async.insert("UPDATE characters SET phone = @myPhoneNumber WHERE charid = @identifier",{['@myPhoneNumber']=t,['@identifier']=r},function()s(t)end)else s(t)end end;function getContacts(r)local l=MySQL.Sync.fetchAll("SELECT * FROM phone_users_contacts WHERE phone_users_contacts.identifier = @identifier",{['@identifier']=r})return l end;function addContact(source,r,u,v)local q=tonumber(source)MySQL.Async.insert("INSERT INTO phone_users_contacts (`identifier`, `number`,`display`) VALUES(@identifier, @number, @display)",{['@identifier']=r,['@number']=u,['@display']=v},function()notifyContactChange(q,r)end)end;function updateContact(source,r,n,u,v)local q=tonumber(source)MySQL.Async.insert("UPDATE phone_users_contacts SET number = @number, display = @display WHERE id = @id",{['@number']=u,['@display']=v,['@id']=n},function()notifyContactChange(q,r)end)end;function deleteContact(source,r,n)local q=tonumber(source)MySQL.Sync.execute("DELETE FROM phone_users_contacts WHERE `identifier` = @identifier AND `id` = @id",{['@identifier']=r,['@id']=n})notifyContactChange(q,r)end;function deleteAllContact(r)MySQL.Sync.execute("DELETE FROM phone_users_contacts WHERE `identifier` = @identifier",{['@identifier']=r})end;function notifyContactChange(source,r)local q=tonumber(source)local r=r;if q~=nil then TriggerClientEvent("gcPhone:contactList",q,getContacts(r))end end;RegisterServerEvent('gcPhone:addContact')AddEventHandler('gcPhone:addContact',function(v,phoneNumber)local q=tonumber(source)local r=getPlayerID(source)addContact(q,r,phoneNumber,v)end)RegisterServerEvent('gcPhone:updateContact')AddEventHandler('gcPhone:updateContact',function(n,v,phoneNumber)local q=tonumber(source)local r=getPlayerID(source)updateContact(q,r,n,phoneNumber,v)end)RegisterServerEvent('gcPhone:deleteContact')AddEventHandler('gcPhone:deleteContact',function(n)local q=tonumber(source)local r=getPlayerID(source)deleteContact(q,r,n)end)function getMessages(r)local l=MySQL.Sync.fetchAll("SELECT phone_messages.* FROM phone_messages LEFT JOIN characters ON characters.charid = @identifier WHERE phone_messages.receiver = characters.phone",{['@identifier']=r})return l end;RegisterServerEvent('gcPhone:_internalAddMessage')AddEventHandler('gcPhone:_internalAddMessage',function(w,x,y,z,s)s(_internalAddMessage(w,x,y,z))end)function _internalAddMessage(w,x,y,z)local A={['@transmitter']=w,['@receiver']=x,['@message']=y,['@isRead']=z,['@owner']=z}local B=MySQL.Sync.fetchAll("INSERT INTO phone_messages (`transmitter`,`receiver`,`message`,`isRead`,`owner`) VALUES(@transmitter,@receiver,@message,@isRead,@owner);",A)local C=MySQL.Sync.fetchAll('SELECT * FROM phone_messages;')local D=0;for E=1,#C do if E==#C then D=C[E].id end end;local F=MySQL.Sync.fetchAll('SELECT * FROM phone_messages WHERE id = @id;',{['@id']=D})return F[1]end;local G={}function addMessage(source,r,m,y)Citizen.Wait(math.random(50,900))table.insert(G,{source=source,identifier=r,phone_number=m,message=y})HoppeSendMessages()end;function HoppeSendMessages()for E=1,#G do Citizen.Wait(50)local q=tonumber(G[E].source)local H=getIdentifierByPhoneNumber(G[E].phone_number)local I=getNumberPhone(G[E].identifier)if H~=nil then local J=MySQL.Sync.fetchAll("SELECT * FROM characters WHERE charid = @charid",{["@charid"]=H})if J then local K=API.getUserFromUserId(J[1].user_id)if K then local L=K:getSource()if L then local M=_internalAddMessage(I,G[E].phone_number,G[E].message,0)TriggerClientEvent("gcPhone:receiveMessage",tonumber(L),M)TriggerClientEvent("Notify",tonumber(L),"imporante","Nova mensagem no seu celular!")end end end else _internalAddMessage(I,G[E].phone_number,G[E].message,0)end;print("source")local N=_internalAddMessage(G[E].phone_number,I,G[E].message,1)TriggerClientEvent("gcPhone:receiveMessage",q,N)table.remove(G,E)end end;function setReadMessageNumber(r,num)local O=getNumberPhone(r)MySQL.Sync.execute("UPDATE phone_messages SET phone_messages.isRead = 1 WHERE phone_messages.receiver = @receiver AND phone_messages.transmitter = @transmitter",{['@receiver']=O,['@transmitter']=num})end;function deleteMessage(P)MySQL.Sync.execute("DELETE FROM phone_messages WHERE `id` = @id",{['@id']=P})end;function deleteAllMessageFromPhoneNumber(source,r,m)local source=source;local r=r;local O=getNumberPhone(r)MySQL.Sync.execute("DELETE FROM phone_messages WHERE `receiver` = @mePhoneNumber and `transmitter` = @phone_number",{['@mePhoneNumber']=O,['@phone_number']=m})end;function deleteAllMessage(r)local O=getNumberPhone(r)MySQL.Sync.execute("DELETE FROM phone_messages WHERE `receiver` = @mePhoneNumber",{['@mePhoneNumber']=O})end;local Q={}local R={}function serviceMessage(S,q,y,T)local source=q;local U=vRP.getUserId(source)local V=false;if U then TriggerClientEvent("gcPhone:forceClosePhone",source)Citizen.Wait(500)local W;if T=="call"then W=vRP.prompt(source,"Descrição:","")if W==""then return end else W=y;if W==""then return end end;local X,Y,Z=vRPclient.getPosition(source)local _={}local a0=false;if S=="911"then if R[U]=="911"then TriggerClientEvent("Notify",source,"negado","Já Existe um chamado sendo averiguado!")return end;_=vRP.getUsersByPermission("policia.permissao")a0="policiais"elseif S=="112"then if R[U]=="112"then TriggerClientEvent("Notify",source,"negado","Já Existe um chamado sendo averiguado!")return end;_=vRP.getUsersByPermission("paramedico.permissao")a0="paramédicos"elseif S=="mechanic"then if R[U]=="mechanic"then TriggerClientEvent("Notify",source,"negado","Já Existe um chamado sendo averiguado!")return end;_=vRP.getUsersByPermission("mecanico.permissao")a0="mecânicos"elseif S=="taxi"then if R[U]=="taxi"then TriggerClientEvent("Notify",source,"negado","Já Existe um chamado sendo averiguado!")return end;_=vRP.getUsersByPermission("taxista.permissao")a0="taxistas"elseif S=="ADM"then if R[U]=="ADM"then TriggerClientEvent("Notify",source,"negado","Já Existe um chamado sendo averiguado!")return end;_=vRP.getUsersByPermission("admin.permissao")a0="Administradores"end;local a1=""if a0=="Administradores"then a1="[ADM] "end;vRPclient.playSound(source,"Event_Message_Purple","GTAO_FM_Events_Soundset")if#_==0 and a0~="policiais"then TriggerClientEvent("Notify",source,"importante","Não há "..a0 .." em serviço.")else local a2=vRP.getUserIdentity(U)TriggerClientEvent("Notify",source,"sucesso","Chamado enviado com sucesso.")R[U]=S;for a3,a4 in pairs(_)do local a5=vRP.getUserSource(parseInt(a4))local a6=vRP.getUserId(a5)if a5 and a5~=source then async(function()vRPclient.playSound(a5,"Out_Of_Area","DLC_Lowrider_Relay_Race_Sounds")TriggerClientEvent('chatMessage',a5,"CHAMADO",{19,197,43},a1 .."Enviado por ^1"..a2.name.." "..a2.firstname.."^0 ["..U.."], "..W)SetTimeout(30000,function()R[U]=false end)local a7=vRP.request(a5,"Aceitar o chamado de <b>"..a2.name.." "..a2.firstname.."</b>?",30)if a7 then if not V then V=true;local a8=vRP.getUserIdentity(a6)TriggerClientEvent("Notify",source,"importante","Chamado atendido por <b>"..a8.name.." "..a8.firstname.."</b>, aguarde no local.")vRPclient.playSound(source,"Event_Message_Purple","GTAO_FM_Events_Soundset")vRPclient._setGPS(a5,X,Y)else TriggerClientEvent("Notify",a5,"importante","Chamado ja foi atendido por outra pessoa.")vRPclient.playSound(a5,"CHECKPOINT_MISSED","HUD_MINI_GAME_SOUNDSET")end end;local n=d:gen()Q[n]=vRPclient.addBlip(a5,X,Y,Z,358,71,"Chamado",0.6,false)SetTimeout(300000,function()vRPclient.removeBlip(a5,Q[n])d:free(n)end)end)end end end end end;RegisterServerEvent('gcPhone:sendMessage')AddEventHandler('gcPhone:sendMessage',function(phoneNumber,y)local q=tonumber(source)local X,Y,Z=cAPI.getPosition(source)phoneNumber=string.gsub(phoneNumber,"%s+","")if phoneNumber=="911"then TriggerEvent("hoppe:call:send","pmesp",y,X,Y,Z)elseif phoneNumber=="112"then TriggerEvent("hoppe:call:send","samu",y,X,Y,Z)elseif phoneNumber=="taxi"then elseif phoneNumber=="mechanic"then TriggerEvent("hoppe:call:send","mecanico",y,X,Y,Z)elseif phoneNumber=="ADM"then else local r=getPlayerID(source)addMessage(q,r,phoneNumber,y)end end)RegisterServerEvent('gcPhone:deleteMessage')AddEventHandler('gcPhone:deleteMessage',function(P)deleteMessage(P)end)RegisterServerEvent('gcPhone:deleteMessageNumber')AddEventHandler('gcPhone:deleteMessageNumber',function(u)local q=tonumber(source)local r=getPlayerID(source)deleteAllMessageFromPhoneNumber(q,r,u)end)RegisterServerEvent('gcPhone:deleteAllMessage')AddEventHandler('gcPhone:deleteAllMessage',function()local q=tonumber(source)local r=getPlayerID(source)deleteAllMessage(r)end)RegisterServerEvent('gcPhone:setReadMessageNumber')AddEventHandler('gcPhone:setReadMessageNumber',function(num)local q=tonumber(source)local r=getPlayerID(source)setReadMessageNumber(r,num)end)RegisterServerEvent('gcPhone:deleteALL')AddEventHandler('gcPhone:deleteALL',function()local q=tonumber(source)local r=getPlayerID(source)deleteAllMessage(r)deleteAllContact(r)appelsDeleteAllHistorique(r)TriggerClientEvent("gcPhone:contactList",q,{})TriggerClientEvent("gcPhone:allMessage",q,{})TriggerClientEvent("appelsDeleteAllHistorique",q,{})end)local a9={}local aa=10;function getHistoriqueCall(num)local l=MySQL.Sync.fetchAll("SELECT * FROM phone_calls WHERE phone_calls.owner = @num ORDER BY time DESC LIMIT 120",{['@num']=num})return l end;function sendHistoriqueCall(src,num)local ab=getHistoriqueCall(num)TriggerClientEvent('gcPhone:historiqueCall',src,ab)end;function saveAppels(ac)if ac.extraData==nil or ac.extraData.useNumber==nil then MySQL.Async.insert("INSERT INTO phone_calls (`owner`,`num`,`incoming`,`accepts`) VALUES(@owner,@num,@incoming,@accepts)",{['@owner']=ac.transmitter_num,['@num']=ac.receiver_num,['@incoming']=1,['@accepts']=ac.is_accepts},function()notifyNewAppelsHisto(ac.transmitter_src,ac.transmitter_num)end)end;if ac.is_valid==true then local num=ac.transmitter_num;if ac.hidden==true then mun="####-####"end;MySQL.Async.insert("INSERT INTO phone_calls (`owner`, `num`,`incoming`, `accepts`) VALUES(@owner, @num, @incoming, @accepts)",{['@owner']=ac.receiver_num,['@num']=num,['@incoming']=0,['@accepts']=ac.is_accepts},function()if ac.receiver_src~=nil then notifyNewAppelsHisto(ac.receiver_src,ac.receiver_num)end end)end end;function notifyNewAppelsHisto(src,num)sendHistoriqueCall(src,num)end;RegisterServerEvent('gcPhone:getHistoriqueCall')AddEventHandler('gcPhone:getHistoriqueCall',function()local q=tonumber(source)local ad=getPlayerID(source)local ae=getNumberPhone(ad)sendHistoriqueCall(q,num)end)RegisterServerEvent('gcPhone:internal_startCall')AddEventHandler('gcPhone:internal_startCall',function(source,m,af,ag)local af=af;if m==nil or m==''then return end;local ah=string.sub(m,1,1)=='#'if ah==true then m=string.sub(m,2)end;local ai=aa;aa=aa+1;local q=tonumber(source)local ad=getPlayerID(source)local ae=''if ag~=nil and ag.useNumber~=nil then ae=ag.useNumber else ae=getNumberPhone(ad)end;local aj=getIdentifierByPhoneNumber(m)local J=MySQL.Sync.fetchAll("SELECT * FROM characters WHERE charid = @charid",{['@charid']=parseInt(aj)})local ak=API.getUserFromUserId(parseInt(J[1].user_id))local al=ak:getSource()print('tplayer',al)local am=aj~=nil and aj~=ad;a9[ai]={id=ai,transmitter_src=q,transmitter_num=ae,receiver_src=nil,receiver_num=m,is_valid=aj~=nil,is_accepts=false,hidden=ah,rtcOffer=af,extraData=ag}if am==true then if aj~=nil then srcTo=al;if srcTo~=nill then a9[ai].receiver_src=srcTo;TriggerClientEvent('gcPhone:waitingCall',q,a9[ai],true)TriggerClientEvent('gcPhone:waitingCall',srcTo,a9[ai],false)TriggerClientEvent("Notify",srcTo,"importante","Alguém está lhe ligando no celular!")else TriggerClientEvent('gcPhone:waitingCall',q,a9[ai],true)end end else TriggerEvent('gcPhone:addCall',a9[ai])TriggerClientEvent('gcPhone:waitingCall',q,a9[ai],true)end end)RegisterServerEvent('gcPhone:startCall')AddEventHandler('gcPhone:startCall',function(m,af,ag)local source=source;phoneNumber=string.gsub(m,"%s+","")if phoneNumber=="911"then serviceMessage(phoneNumber,source,"","call")elseif phoneNumber=="112"then serviceMessage(phoneNumber,source,"","call")elseif phoneNumber=="taxi"then serviceMessage(phoneNumber,source,"","call")elseif phoneNumber=="mechanic"then serviceMessage(phoneNumber,source,"","call")elseif phoneNumber=="ADM"then serviceMessage(phoneNumber,source,"","call")else TriggerEvent('gcPhone:internal_startCall',source,m,af,ag)end end)RegisterServerEvent('gcPhone:candidates')AddEventHandler('gcPhone:candidates',function(an,ao)if a9[an]~=nil then local source=source;local ap=a9[an].transmitter_src;if source==ap then ap=a9[an].receiver_src end;TriggerClientEvent('gcPhone:candidates',ap,ao)end end)RegisterServerEvent('gcPhone:acceptCall')AddEventHandler('gcPhone:acceptCall',function(aq,ar)local n=aq.id;if a9[n]~=nil then a9[n].receiver_src=aq.receiver_src or a9[n].receiver_src;if a9[n].transmitter_src~=nil and a9[n].receiver_src~=nil then a9[n].is_accepts=true;a9[n].rtcAnswer=ar;TriggerClientEvent('gcPhone:acceptCall',a9[n].transmitter_src,a9[n],true)TriggerClientEvent('gcPhone:acceptCall',a9[n].receiver_src,a9[n],false)saveAppels(a9[n])end end end)RegisterServerEvent('gcPhone:rejectCall')AddEventHandler('gcPhone:rejectCall',function(aq)local n=aq.id;if a9[n]~=nil then if a9[n].transmitter_src~=nil then TriggerClientEvent('gcPhone:rejectCall',a9[n].transmitter_src)end;if a9[n].receiver_src~=nil then TriggerClientEvent('gcPhone:rejectCall',a9[n].receiver_src)end;if a9[n].is_accepts==false then saveAppels(a9[n])end;TriggerEvent('gcPhone:removeCall',a9)a9[n]=nil end end)RegisterServerEvent('gcPhone:appelsDeleteHistorique')AddEventHandler('gcPhone:appelsDeleteHistorique',function(as)local q=tonumber(source)local ad=getPlayerID(source)local ae=getNumberPhone(ad)MySQL.Sync.execute("DELETE FROM phone_calls WHERE `owner` = @owner AND `num` = @num",{['@owner']=ae,['@num']=as})end)function appelsDeleteAllHistorique(ad)local ae=getNumberPhone(ad)MySQL.Sync.execute("DELETE FROM phone_calls WHERE `owner` = @owner",{['@owner']=ae})end;RegisterServerEvent('gcPhone:appelsDeleteAllHistorique')AddEventHandler('gcPhone:appelsDeleteAllHistorique',function()local q=tonumber(source)local ad=getPlayerID(source)appelsDeleteAllHistorique(ad)end)RegisterServerEvent('gcPhone:allUpdate')AddEventHandler('gcPhone:allUpdate',function()local q=tonumber(source)local r=getPlayerID(source)local num=getNumberPhone(r)while num==nil do Citizen.Wait(5000)r=getPlayerID(q)num=getNumberPhone(r)print('trying get info for hoppe gcphone => playersrc',source)print("[🐌GCPHONE | HOPPE] => TRYING GET NUMBERPHONE")end;local at=0;local l=MySQL.Sync.fetchAll('SELECT * FROM characters WHERE charid = @charid',{["@charid"]=r})if l[1]then at=l[1].money end;while l[1]==nil do Citizen.Wait(5000)l=MySQL.Sync.fetchAll('SELECT * FROM characters WHERE charid = @charid',{["@charid"]=r})if l[1]then at=l[1].money end;print('trying get info for hoppe gcphone => playersrc',source)print("[🐌GCPHONE | HOPPE] => TRYING GET BMONEY")end;print("[🐌GCPHONE | HOPPE] => "..q.." ADDED")TriggerClientEvent("gcPhone:myPhoneNumber",q,num)TriggerClientEvent("gcPhone:contactList",q,getContacts(r))TriggerClientEvent("gcPhone:allMessage",q,getMessages(r))TriggerClientEvent("vRP:updateBalanceGc",q,at)sendHistoriqueCall(q,num)end)AddEventHandler('onMySQLReady',function()MySQL.Async.fetchAll("DELETE FROM phone_messages WHERE (DATEDIFF(CURRENT_DATE,time) > 10)")end)RegisterNetEvent("vRP/update_gc_phone")AddEventHandler("vRP/update_gc_phone",function()if source~=nil then local f=API.getUserFromSource(_source)if f then local g=f:getCharacter()if g then local h=parseInt(g.id)if h~=nil then MySQL.Async.fetchAll('SELECT * FROM characters WHERE charid = @charid',{['@id']=h},function(l)print('result',l)print('bmoney',l[1].money)local at=l[1].money;TriggerClientEvent("vRP:updateBalanceGc",source,at)end)end end end end end)RegisterServerEvent('bank:transfer')AddEventHandler('bank:transfer',function(n,au)local _source=source;local f=API.getUserFromSource(_source)if f then local g=f:getCharacter()if g then local h=parseInt(g.id)local B=MySQL.Sync.fetchAll("SELECT * FROM characters WHERE charid = @charid",{["@charid"]=h})local at=B[1].money;if tonumber(n)==tonumber(h)then return TriggerClientEvent("Notify",_source,"negado","Você não pode transferir para você mesmo!")end;if tonumber(at)<tonumber(au)then return TriggerClientEvent("Notify",_source,"negado","Você não possui esta quantia no banco!")end;local C=MySQL.Sync.fetchAll("SELECT * FROM characters WHERE charid = @charid",{["@charid"]=parseInt(n)})if#C==0 then return TriggerClientEvent("Notify",_source,"negado","ID inválido/inexistente!")end;local a6=C[1].user_id;local av=tonumber(at)-tonumber(au)local aw=tonumber(C[1].money)+tonumber(au)MySQL.Sync.fetchAll("UPDATE characters SET money = @money WHERE charid = @charid",{["@charid"]=parseInt(h),["@money"]=av})MySQL.Sync.fetchAll("UPDATE characters SET money = @money WHERE charid = @charid",{["@charid"]=parseInt(n),["@money"]=aw})local K=API.getUserFromUserId(a6)local L=K:getSource()TriggerClientEvent("Notify",tonumber(_source),"sucesso","Você transferiu R$"..au.." para o ID: "..n)TriggerClientEvent("Notify",tonumber(L),"sucesso","ID: "..h.." transferiu R$"..au.." para você")TriggerClientEvent("vRP:updateBalanceGc",_source,av)TriggerClientEvent("vRP:updateBalanceGc",L,aw)end end end)