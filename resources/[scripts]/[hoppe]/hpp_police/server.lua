local a=module('_core','libs/Tunnel')local b=module('_core','libs/Proxy')APICKF=b.getInterface('API')cAPI=a.getInterface('cAPI')hppServerPolice={}a.bindInterface("hpp_police",hppServerPolice)local c=a.getInterface("hpp_police")local d=module("_core","config/Permissions")Citizen.CreateThread(function()while true do Citizen.Wait(5*60*1000)collectgarbage("count")collectgarbage("collect")end end)API_Database={}local e=exports['GHMattiMySQL']DBConnect={driver='ghmattimysql',host='127.0.0.1',database='ckf2',user='root',password=''}local f={}local g;local h={}local i={}local j={}local k=false;function API_Database.registerDBDriver(l,m,n,o)if not f[l]then f[l]={m,n,o}if l==DBConnect.driver then g=f[l]local p=m(DBConnect)if p then k=true;for q,r in pairs(h)do n(table.unpack(r,1,table.maxn(r)))end;for q,s in pairs(i)do async(function()s[2](o(table.unpack(s[1],1,table.maxn(s[1]))))end)end;h=nil;i=nil else error('Conexão com o banco de dados perdida.')end end else error('Banco de dados registrado.')end end;function API_Database.format(t)local u,v,w=string.match(t,'^([^%d]*%d)(%d*)(.-)$')return u..v:reverse():gsub('(%d%d%d)','%1.'):reverse()..w end;function API_Database.prepare(l,s)j[l]=true;if k then g[2](l,s)else table.insert(h,{l,s})end end;function API_Database.query(l,x,y)if not j[l]then error('query '..l.." doesn't exist.")end;if not y then y='query'end;if k then return g[3](l,x or{},y)else local z=async()table.insert(i,{{l,x or{},y},z})return z:wait()end end;function API_Database.execute(l,x)return API_Database.query(l,x,'execute')end;local A={}local function m(B)return e~=nil end;local function n(l,s)A[l]=s end;local function o(l,x,y)local s=A[l]local C={}C._=true;for D,E in pairs(x)do C['@'..D]=E end;local z=async()if y=='execute'then e:QueryAsync(s,C,function(F)z(F or 0)end)elseif y=='scalar'then e:QueryScalarAsync(s,C,function(G)z(G)end)else e:QueryResultAsync(s,C,function(H)z(H,#H)end)end;return z:wait()end;Citizen.CreateThread(function()e:Query('SELECT 1')API_Database.registerDBDriver('ghmattimysql',m,n,o)end)API_Database.prepare('CKF_/getInfoDataByCharId','SELECT * FROM characters WHERE charid = @charid')API_Database.prepare('CKF_/getInv','SELECT items FROM inventories WHERE charid = @charid')API_Database.prepare('CKF_/clearInv','CALL remData(@target, @key, @id)')API_Database.prepare('CKF_/getPrisonTime','SELECT * FROM characters WHERE charid = @charid')API_Database.prepare('CKF_/setPrisonTime','UPDATE characters SET prisonTime = @prisonTime WHERE charid = @charid')function hppServerPolice.checkPerm(I)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;local H=API_Database.query('CKF_/getInfoDataByCharId',{charid=M})local N=json.decode(H[1].groups)for D,E in pairs(N)do for O,P in pairs(d)do if D==O then if P.inheritance==I then return true end end end end end;return false end end;function hppServerPolice.checkWeaponTypes()print('weapon_types',weapon_types)return weapon_types end;function hppServerPolice.stockWeapons(Q)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;local R=0;for D,E in pairs(Q)do local S=string.lower(D)local T=E.ammo;local U=string.gsub(S,"weapon","ammo")local V=APICKF.getItemDataFromId(S)local W=tonumber(V:getWeight())local X=APICKF.getItemDataFromId(U)local Y=tonumber(X:getWeight())*tonumber(T)local Z=tonumber(W)+tonumber(Y)R=R+Z end;local _=L.Inventory:getCapacity()-L.Inventory:getWeight()if hppServerPolice.checValues(_,R)then TriggerClientEvent("Notify",J,"sucesso","Você guardou suas armas!")for D,E in pairs(Q)do local S=string.lower(D)local T=E.ammo;local U=string.gsub(S,"weapon","ammo")L:addItem(S,1)L:addItem(U,parseInt(T))end;TriggerClientEvent("hpp:stock:weapons",J)else TriggerClientEvent("Notify",J,"negado","Espaço insuficiente!")end end end end;RegisterNetEvent("hoppe:show:id")AddEventHandler("hoppe:show:id",function(a0)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then if a0~=nil and a0~=0 then local a1=APICKF.getUserFromSource(a0)if a1 then local a2=a1:getCharacter()if a2 then if L:hasGroup("admin")then local a3=MySQL.Sync.fetchAll("SELECT * FROM characters WHERE charid = @charid",{["@charid"]=a2.id})print("bmoney",a3[1].money)TriggerClientEvent('chatMessage',J,"ADMIN:",{255,0,0},"ID:"..a2.id.." | Nome:"..a2.charName.." | Dinheiro:"..a3[1].money.." ")else if L:hasGroup("pmesp")then TriggerClientEvent('chatMessage',J,"PD:",{55,55,255},"ID:"..a2.id.." | Nome:"..a2.charName.."")else TriggerClientEvent('chatMessage',J,"ID PRÓXIMO:",{255,0,0},a2.id)end end end end end end end end)function hppServerPolice.checValues(a4,a5)return a4>a5 end;RegisterNetEvent("hoppe:build:prison:time")AddEventHandler("hoppe:build:prison:time",function()local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;local H=API_Database.query('CKF_/getPrisonTime',{charid=M})print("#rows",#H)print("charid",M)print("rows[1].prisonTime",H[1].prisonTime)TriggerClientEvent("hoppe:build:prison:time",J,H[1].prisonTime)end end end)function hppServerPolice.getPrisonTime()local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;local H=API_Database.query('CKF_/getPrisonTime',{charid=M})print("#rows",#H)print("charid",M)print("rows[1].prisonTime",H[1].prisonTime)return H[1].prisonTime end end end;RegisterNetEvent("hoppe:setPrisonTime")AddEventHandler("hoppe:setPrisonTime",function(a6)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;API_Database.query('CKF_/setPrisonTime',{charid=M,prisonTime=parseInt(a6)})end end end)function hppServerPolice.setPrisonTime(a6)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;API_Database.query('CKF_/setPrisonTime',{charid=M,prisonTime=parseInt(a6)})end end end;RegisterNetEvent("hoppe:server:prender")AddEventHandler("hoppe:server:prender",function(a7,a8)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then if parseInt(a8)~=0 then local a9=APICKF.getUserFromUserId(parseInt(a7)):getSource()TriggerClientEvent("hoppe:prender",a9,parseInt(a8))local M=L.id;API_Database.query('CKF_/setPrisonTime',{charid=M,prisonTime=parseInt(a8)})end end end end)RegisterNetEvent("hoppe:carregar")AddEventHandler("hoppe:carregar",function(a0)local J=source;local K=APICKF.getUserFromSource(J)local L=K:getCharacter()local M=L.id;local aa=a0;if aa~=nil and aa~=0 then if L:hasGroup("pmesp")or L:hasGroup("samu")then TriggerClientEvent('carregar',aa,J)end end end)RegisterNetEvent("hoppe:algema")AddEventHandler("hoppe:algema",function(a0)local J=source;local K=APICKF.getUserFromSource(J)local L=K:getCharacter()local M=L.id;if not L:hasGroup("pmesp")then return end;local aa=tonumber(parseInt(a0))if aa~=0 and aa~=nil then if cAPI.isHandcuffed(aa)then TriggerClientEvent("vrp_sound:source",J,'uncuff',0.1)TriggerClientEvent("vrp_sound:source",aa,'uncuff',0.1)c.stopAnim(aa,true)cAPI.toggleHandcuff(aa)else TriggerClientEvent('cancelando',J,true)TriggerClientEvent('cancelando',aa,true)TriggerClientEvent('carregar',aa,J)c.playAnim(J,false,"mp_arrest_paired","cop_p2_back_left",false)c.playAnim(aa,false,"mp_arrest_paired","crook_p2_back_left",false)Citizen.Wait(3500)TriggerClientEvent('carregar',aa,J)TriggerClientEvent('cancelando',J,false)TriggerClientEvent('cancelando',aa,false)TriggerClientEvent("vrp_sound:source",J,'cuff',0.1)TriggerClientEvent("vrp_sound:source",aa,'cuff',0.1)c.stopAnim(J,false)c.playAnim(aa,true,"mp_arresting","idle",true)cAPI.toggleHandcuff(aa)end else TriggerClientEvent("Notify",J,"negado","Nenhum player próximo!")end end)RegisterNetEvent("hoppe:medhealing")AddEventHandler("hoppe:medhealing",function(a0)local J=source;local K=APICKF.getUserFromSource(J)local L=K:getCharacter()local M=L.id;local aa=a0;local ab=cAPI.getHealth(aa)if aa~=0 and aa~=nil then if ab==101 or ab<101 then TriggerClientEvent("hoppe:medhealing",J,"anim")Citizen.Wait(1000)TriggerClientEvent("hoppe:medhealing",aa,"healing")else TriggerClientEvent("Notify",J,"negado","Este jogador não está morto!")end else TriggerClientEvent("Notify",J,"negado","Ninguém por perto para socorrer!")end end)RegisterNetEvent("hpp:put:in:vehicle")AddEventHandler("hpp:put:in:vehicle",function(a0)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then if L:hasGroup("pmesp")or L:hasGroup("samu")then TriggerClientEvent("hpp:put:in:vehicle",a0)end end end end)RegisterNetEvent("hpp:sequestro")AddEventHandler("hpp:sequestro",function(a0)TriggerClientEvent("hpp:sequestro",a0)end)RegisterServerEvent("trymala")AddEventHandler("trymala",function(ac)TriggerClientEvent("syncmala",-1,ac)end)RegisterNetEvent("hpp:eject:vehicle")AddEventHandler("hpp:eject:vehicle",function(a0)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then if L:hasGroup("pmesp")or L:hasGroup("samu")then TriggerClientEvent("hpp:eject:vehicle",a0)end end end end)RegisterNetEvent("tratamento-macas")AddEventHandler("tratamento-macas",function(a0)local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;if not L:hasGroup("samu")then return end;local aa=a0;if aa~=0 and aa~=nil then print("TargetSource",aa)print("hpp_police_client.returnlying(TargetSource)",c.returnlying(aa))if c.returnlying(aa)then TriggerClientEvent("tratamento-macas",aa)TriggerClientEvent("med-notify",J,"<b>~r~[AVISO] ~w~Tratamento iniciado!</b>")else TriggerClientEvent("med-notify",J,"<b>~r~[AVISO] ~w~O jogador não está na maca!</b>")end else TriggerClientEvent("med-notify",J,"<b>~r~[AVISO] ~w~Ninguém por perto para tratar!</b>")end end end end)RegisterNetEvent("hoppe:clear:inventory")AddEventHandler("hoppe:clear:inventory",function()local J=source;local K=APICKF.getUserFromSource(J)if K then local L=K:getCharacter()if L then local M=L.id;local ad=API_Database.query('CKF_/getInv',{charid=M})local ae=json.decode(ad[1].items)for O,P in pairs(ae)do L:removeItem(O,parseInt(P))end;local H=API_Database.query("CKF_/getInfoDataByCharId",{charid=M})if H[1].vip=="NENHUM"then L.Inventory:setCapacity(5)else if H[1].vip=="vip100"then end;if H[1].vip=="vip50"then if parseInt(L.Inventory:getCapacity())==38 then L.Inventory:setCapacity(5)print("VIP OURO PERDE MOCHILA GRANDE")end end end;print("[CLEAR INVENTORY]"..M)end end end)RegisterCommand("190",function(source,af,ag)local J=source;local K=APICKF.getUserFromSource(J)local I="policePerm"if K then local L=K:getCharacter()local M=L.id;local H=API_Database.query('CKF_/getInfoDataByCharId',{charid=M})local N=json.decode(H[1].groups)for D,E in pairs(N)do for O,P in pairs(d)do if D==O then if P.inheritance==I then TriggerClientEvent('chatMessage',-1,"190: "..L.charName.." ",{63,103,254},ag:sub(4))return true end end end end;return false end end)RegisterCommand("pd",function(source,af,ag)local J=source;local K=APICKF.getUserFromSource(J)local I="policePerm"if K then local L=K:getCharacter()if L then local M=L.id;local H=API_Database.query('CKF_/getInfoDataByCharId',{charid=M})local N=json.decode(H[1].groups)for D,E in pairs(N)do for O,P in pairs(d)do if D==O then if P.inheritance==I then local ah=ag:sub(4)local ai={55,55,255}local aj="PD: "..L.charName.." "TriggerClientEvent("hoppe:pd:chat:event",-1,aj,ai,ah)return true end end end end;return false end end end)RegisterNetEvent("hoppe:pd:chat:event")AddEventHandler("hoppe:pd:chat:event",function(aj,ai,ah)local J=source;local K=APICKF.getUserFromSource(J)local I="policePerm"if K then local L=K:getCharacter()if L then local M=L.id;local H=API_Database.query('CKF_/getInfoDataByCharId',{charid=M})local N=json.decode(H[1].groups)for D,E in pairs(N)do for O,P in pairs(d)do if D==O then if P.inheritance==I then TriggerClientEvent('chatMessage',J,aj,ai,ah)return true end end end end;return false end end end)RegisterCommand("192",function(source,af,ag)local J=source;local K=APICKF.getUserFromSource(J)local I="medicPerm"if K then local L=K:getCharacter()local M=L.id;local H=API_Database.query('CKF_/getInfoDataByCharId',{charid=M})local N=json.decode(H[1].groups)for D,E in pairs(N)do for O,P in pairs(d)do if D==O then if P.inheritance==I then TriggerClientEvent('chatMessage',-1,"192: "..L.charName.." ",{255,120,120},ag:sub(4))return true end end end end;return false end end)RegisterNetEvent("hoppe:wanted:sendNotify")AddEventHandler("hoppe:wanted:sendNotify",function(ak,al,am,ah,an,ao,ap)TriggerClientEvent("hoppe:wanted:sendNotify",-1,ak,al,am,ah,an,ao,ap)end)RegisterNetEvent("hoppe:jacking:updateBlipPos")AddEventHandler("hoppe:jacking:updateBlipPos",function(ak,al,am,ap)TriggerClientEvent("hoppe:jacking:updateBlipPos",-1,ak,al,am,ap)end)RegisterNetEvent("hoppe:wanted:removeBlip")AddEventHandler("hoppe:wanted:removeBlip",function()TriggerClientEvent("hoppe:wanted:removeBlip",-1)end)